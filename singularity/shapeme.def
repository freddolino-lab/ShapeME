Bootstrap: docker
From: frolvlad/alpine-miniconda3
Stage: build

%setup
    mkdir ${SINGULARITY_ROOTFS}/src
    mkdir -p ${SINGULARITY_ROOTFS}/src/rust_utils/target/release
    cp -r ../src/python3 ${SINGULARITY_ROOTFS}/src/
    #cp -r ../src/rust_utils ${SINGULARITY_ROOTFS}/src/
    cp ../src/rust_utils/target/x86_64-unknown-linux-musl/release/evaluate_motifs ${SINGULARITY_ROOTFS}/src/rust_utils/target/release/
    cp ../src/rust_utils/target/x86_64-unknown-linux-musl/release/filter_motifs ${SINGULARITY_ROOTFS}/src/rust_utils/target/release/
    cp ../src/rust_utils/target/x86_64-unknown-linux-musl/release/get_robustness ${SINGULARITY_ROOTFS}/src/rust_utils/target/release/
    cp ../src/rust_utils/target/x86_64-unknown-linux-musl/release/infer_motifs ${SINGULARITY_ROOTFS}/src/rust_utils/target/release/
    chmod -R 755 ${SINGULARITY_ROOTFS}/src

%environment
    export SHAPEME_VER=0.2.1
    export PATH="/opt/conda/envs/motifer/bin:/opt/conda/bin:${PATH}"

%files
    env_spec.yaml
    shapeme.bashrc /shapeme.bashrc

%runscript
    /bin/bash -rcfile /shapeme.bashrc

%post
    export PATH="/conda/envs/motifer/bin:/opt/conda/bin:${PATH}" \
    && apk update \
    && apk upgrade \
    && apk add bash libffi libffi-dev libarchive \
    && conda update -y -n base conda \
    && conda install anaconda \
    && conda install -c conda-forge mamba \
    && mamba env create -f env_spec.yaml \
    && cd 

    CUSTOM_ENV=/.singularity.d/env/99-zz_custom_env.sh
    cat >$CUSTOM_ENV <<EOF
#!/bin/bash
PS1="[shapeme_0.2.1]\w \$"
EOF
    chmod 755 $CUSTOM_ENV

%test
    which python
    source /opt/conda/etc/profile.d/conda.sh
    conda activate motifer
    python -c "import numpy; print(numpy.__file__)"
